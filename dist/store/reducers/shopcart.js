"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}Object.defineProperty(exports,"__esModule",{value:!0});var _handleActions,_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(t[a]=r[a])}return t},_lodash=require("./../../npm/lodash/lodash.js"),_lodash2=_interopRequireDefault(_lodash),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_reduxActions=require("./../../npm/redux-actions/lib/index.js"),_shopcart=require("./../types/shopcart.js"),_shopcart2=_interopRequireDefault(_shopcart),SHOP_BUY_LIST="SHOP_BUY_LIST",SHOP_CART_LIST="SHOP_CART_LIST",initState={shopCartData:[],shopCartList:[],shopBuyList:[],shopBuyType:1,isSelectedAll:!1,totalAmount:0,shopCartCount:0},getSelectStatus=function(t){try{return t.every(function(t){return 1==t.isSelected})}catch(t){}},getTotalAmount=function(t){try{var e=0;return t.forEach(function(t){var r=NaN!=Number(t.price)?Number(t.price):0,a=NaN!=Number(t.count)?Number(t.count):0;t.isSelected&&(e+=r*a)}),e.toFixed(2)}catch(t){}},reducers=(0,_reduxActions.handleActions)((_handleActions={},_defineProperty(_handleActions,_shopcart2.default.GET_SHOP_CART,function(t,e){var r=(e.type,e.payload),a=Array.from(new Set(_wepy2.default.getStorageSync(SHOP_CART_LIST)||[])),n=Array.from(new Set(a.filter(function(t){return t.uid==r.uid}))),o=getSelectStatus(n),i=getTotalAmount(n),u=n.length;return _extends({},t,{shopCartData:a,shopCartList:n,isSelectedAll:o,totalAmount:i,shopCartCount:u})}),_defineProperty(_handleActions,_shopcart2.default.SET_SHOP_CART,function(t,e){var r=(e.type,e.payload),a=t.shopCartData.concat();try{a=a.map(function(t){return t.uid==r.uid&&t.id==r.id&&t.sid==r.sid&&(t=r),t})}catch(t){}var n=a.filter(function(t){return t.uid==r.uid}),o=getSelectStatus(n),i=getTotalAmount(n),u=n.length;return _wepy2.default.setStorageSync(SHOP_CART_LIST,a),_extends({},t,{shopCartData:a,shopCartList:n,isSelectedAll:o,totalAmount:i,shopCartCount:u})}),_defineProperty(_handleActions,_shopcart2.default.SYNC_SHOP_CART,function(t,e){var r=(e.type,e.payload);console.log("SYNC_SHOP_CART",r)}),_defineProperty(_handleActions,_shopcart2.default.DEL_SHOP_CART,function(t,e){var r=(e.type,e.payload),a=t.shopCartData.concat();try{var n=a.findIndex(function(t){return t.id==r.id&&t.uid==r.uid&&t.sid==r.sid});a.splice(n,1)}catch(t){}var o=a.filter(function(t){return t.uid==r.uid}),i=getSelectStatus(o),u=getTotalAmount(o),s=o.length;return _wepy2.default.setStorageSync(SHOP_CART_LIST,a),_extends({},t,{shopCartData:a,shopCartList:o,isSelectedAll:i,totalAmount:u,shopCartCount:s})}),_defineProperty(_handleActions,_shopcart2.default.ADD_SHOP_CART,function(t,e){var r=(e.type,e.payload),a=t.shopCartData.concat();try{if(r.constructor==Object){a.find(function(t){return t.id==r.id&&t.uid==r.uid&&t.sid==r.sid})?a=a.map(function(t){if(t.id==r.id&&t.uid==r.uid&&t.sid==r.sid){t.isSelected=!0;var e=t.count+r.count;t.count=t.stock>e?e:t.stock}return t}):a.push(Object.assign({},r,{isSelected:!0}))}}catch(t){}var n=a.filter(function(t){return t.uid==r.uid}),o=getSelectStatus(n),i=getTotalAmount(n),u=n.length;return _wepy2.default.setStorageSync(SHOP_CART_LIST,a),_extends({},t,{shopCartData:a,shopCartList:n,isSelectedAll:o,totalAmount:i,shopCartCount:u})}),_defineProperty(_handleActions,_shopcart2.default.CHECK_ONE_SHOP_CART,function(t,e){var r=(e.type,e.payload),a=t.shopCartData.concat();try{a=a.map(function(t){return t.uid==r.uid&&t.id==r.id&&t.sid==r.sid&&(t.isSelected=!t.isSelected),t})}catch(t){}var n=a.filter(function(t){return t.uid==r.uid}),o=getSelectStatus(n),i=getTotalAmount(n);return _wepy2.default.setStorageSync(SHOP_CART_LIST,a),_extends({},t,{shopCartData:a,shopCartList:n,isSelectedAll:o,totalAmount:i})}),_defineProperty(_handleActions,_shopcart2.default.CHECK_ALL_SHOP_CART,function(t,e){var r=(e.type,e.payload),a=t.shopCartData.concat(),n=!t.isSelectedAll;try{a=a.map(function(t){return t.uid==r.uid&&(t.isSelected=n),t})}catch(t){}var o=a.filter(function(t){return t.uid==r.uid}),i=getTotalAmount(o);return _wepy2.default.setStorageSync(SHOP_CART_LIST,a),_extends({},t,{shopCartData:a,shopCartList:o,isSelectedAll:n,totalAmount:i})}),_defineProperty(_handleActions,_shopcart2.default.SET_BUY_LIST,function(t,e){var r=(e.type,e.payload),a=t.shopBuyList.concat(),n=t.shopBuyType;if(r)return r.constructor==Object?(a=[Object.assign({},r,{isSelected:!0})],n=3==r.type?2:1):r.constructor==Array&&(a=r.map(function(t){return t.isSelected=!0,t}),n=3==a[0].type?2:1),_wepy2.default.setStorageSync(SHOP_BUY_LIST,a),_extends({},t,_defineProperty({shopBuyList:a},"shopBuyList",a));var o=t.shopCartList.concat();try{a=o.filter(function(t){return t.isSelected}),n=3==a[0].type?2:1}catch(t){}return _wepy2.default.setStorageSync(SHOP_BUY_LIST,a),_extends({},t,{shopBuyList:a,shopBuyType:n})}),_defineProperty(_handleActions,_shopcart2.default.GET_BUY_LIST,function(t,e){var r=(e.type,e.payload,_wepy2.default.getStorageSync(SHOP_BUY_LIST)||t.shopBuyList.concat()),a=getTotalAmount(r),n=3==r[0].type?2:1;return _extends({},t,{totalAmount:a,shopBuyList:r,shopBuyType:n})}),_defineProperty(_handleActions,_shopcart2.default.REMOVE_BUY_LIST,function(t,e){var r=(e.type,e.payload,t.shopCartData.concat()),a=[],n=null;try{t.shopBuyList.forEach(function(t){var e=r.findIndex(function(e){return e.id==t.id&&e.uid==t.uid&&e.sid==t.sid});console.log(e),e>-1&&(n=r[e].uid,r.splice(e,1))})}catch(t){}var o=r.filter(function(t){return t.uid==n}),i=getSelectStatus(o),u=getTotalAmount(o),s=o.length;return _wepy2.default.setStorageSync(SHOP_CART_LIST,r),_wepy2.default.setStorageSync(SHOP_BUY_LIST,a),_extends({},t,{shopCartData:r,shopCartList:o,shopBuyList:a,isSelectedAll:i,totalAmount:u,shopCartCount:s})}),_handleActions),initState);exports.default=reducers;