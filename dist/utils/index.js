"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(a,u){try{var o=t[a](u),s=o.value}catch(e){return void r(e)}if(!o.done)return Promise.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}return n("next")})}}function redirect(e){if(e)return _wepy2.default.redirectTo({url:"/pages/auth/login"}),!1;_wepy2.default.redirectTo({url:e})}function showToast(e,t){var r="/images/toast-warn.png";switch(t){case"success":r="/images/toast-success.png";break;case"error":r="/images/toast-error.png";break;case"info":r="/images/toast-info.png";break;case"warn":r="/images/toast-warn.png"}_wepy2.default.showToast({title:e,image:r})}var request=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object.assign({},{url:t,data:{},header:{},method:"GET"},r),e.abrupt("return",new Promise(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:_wepy2.default.request({url:n.url,data:n.data,method:n.method,header:Object.assign({},{"Content-Type":"application/json",token:_wepy2.default.getStorageSync("token")},n.header),success:function(e){}}).then(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.status){e.next=3;break}return e.abrupt("return",t(n));case 3:if(u=[100020,100021,100022,100023,100024],!u.some(function(e){return e==n.errCode})){e.next=7;break}return showToast(n.message),e.abrupt("return",r(n));case 7:return e.abrupt("return",r(n));case 8:case"end":return e.stop()}},e,a)}));return function(t){return e.apply(this,arguments)}}()).catch(r);case 1:case"end":return e.stop()}},e,a)}));return function(t,r){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}(),checkSession=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,_wepy2.default.checkSession();case 3:return e.abrupt("return",e.sent);case 6:return e.prev=6,e.t0=e.catch(0),e.abrupt("return",!1);case 9:case"end":return e.stop()}},e,this,[[0,6]])}));return function(){return e.apply(this,arguments)}}(),checkLogin=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=!1,!_wepy2.default.getStorageSync("token")){e.next=5;break}return e.next=4,checkSession();case 4:t=e.sent;case 5:return e.abrupt("return",t);case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}(),getuid=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,checkLogin();case 2:if(t=e.sent,r=null,n=null,!t){e.next=12;break}return r=_wepy2.default.getStorageSync("uid"),n=_wepy2.default.getStorageSync("token"),_wepy2.default.$instance.globalData.uid=r,_wepy2.default.$instance.globalData.token=n,e.abrupt("return",{uid:r,token:n});case 12:return e.next=14,login();case 14:return e.abrupt("return",e.sent);case 15:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}(),getShareInfo=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,request(_api2.default.share.default).then(function(e){var t=e.result;_wepy2.default.$instance.globalData.shareInfo=t||{}}).catch(function(e){});case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}(),login=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,u,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,checkLogin();case 2:return t=e.sent,r=_wepy2.default.getStorageSync("uid")||null,n=_wepy2.default.getStorageSync("token")||null,e.next=6,_wepy2.default.login();case 6:return a=e.sent,u=a.code,e.next=10,getUserInfo();case 10:return o=e.sent,s=o.userInfo,e.next=14,request(_api2.default.user.login,{data:{code:u,userInfo:s},method:"POST"}).then(function(e){var t=e.result;r=t.uid,n=t.token}).catch(function(e){});case 14:return _wepy2.default.setStorageSync("uid",r),_wepy2.default.setStorageSync("token",n),_wepy2.default.$instance.globalData.uid=r,_wepy2.default.$instance.globalData.token=n,e.abrupt("return",{uid:r,token:n});case 19:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}(),getUserInfo=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,_wepy2.default.getUserInfo({withCredentials:!0});case 3:return e.abrupt("return",e.sent);case 6:return e.prev=6,e.t0=e.catch(0),e.abrupt("return",!1);case 9:case"end":return e.stop()}},e,this,[[0,6]])}));return function(){return e.apply(this,arguments)}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_api=require("./api.js"),_api2=_interopRequireDefault(_api),formatTime=function(e){var t=e.getFullYear(),r=e.getMonth()+1,n=e.getDate(),a=e.getHours(),u=e.getMinutes(),o=e.getSeconds();return[t,r,n].map(formatNumber).join("/")+" "+[a,u,o].map(formatNumber).join(":")},formatNumber=function(e){return e=e.toString(),e[1]?e:"0"+e},getlen=function(e){for(var t=e.length,r=0,n=0;n<t;n++)e.charCodeAt(n)>128?r+=2:r+=1;return Math.ceil(r)},cutstr=function(e,t){for(var r=e.length,n=r,a=0,u=0;u<r;u++)if(e.charCodeAt(u)>128){if(!(a+2<t)){n=u;break}a+=2}else{if(!(a+1<t)){n=u;break}a+=1}return n},hex2rgba=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;try{if(e.indexOf("rgba(")>-1){var r=e.match(new RegExp(/(\w+)/,"ig"));return"rgba("+r[1]+","+r[2]+","+r[3]+","+t+")"}if(e.indexOf("rgb(")>-1){var n=e.match(new RegExp(/(\w+)/,"ig"));return"rgba("+n[1]+","+n[2]+","+n[3]+","+t+")"}if(e.indexOf("#")<0||e.length<4||e.length>=5&&e.length<=6)return e;e=4==e.length?""+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]:e;var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e),u=parseInt(a[1],16),o=parseInt(a[2],16),s=parseInt(a[3],16);return a?"rgba("+u+","+o+","+s+","+t+")":e}catch(e){return"#ffffff"}},status2str=function(e,t){var r="";if("order"==t)switch(e){case 0:r="待付款";break;case 1:r="待发货";break;case 2:r="待收货";break;case 3:r="待评价";break;case 4:r="已完成";break;default:r="已失效"}return r},thumbnail=function(e,t){return t=t||"400x400",e+"_"+t+e.substring(e.lastIndexOf("."),e.length)};module.exports={formatTime:formatTime,hex2rgba:hex2rgba,getlen:getlen,cutstr:cutstr,status2str:status2str,thumbnail:thumbnail,request:request,checkLogin:checkLogin,checkSession:checkSession,login:login,getUserInfo:getUserInfo,getShareInfo:getShareInfo,redirect:redirect,showToast:showToast};